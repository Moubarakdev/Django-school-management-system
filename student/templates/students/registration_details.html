{% extends 'layouts/base_dash.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load permission_tags %}

{% block title %}
Détails
{% endblock title %}


{% block content %}
<div class="content container-fluid">
    <div class="page-header">
        <div class="row">
            <div class="col-sm-12">
                <h3 class="page-title"> Details de la demande</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:student:all_applicants' %}">Liste des
                        demandes</a></li>
                    <li class="breadcrumb-item active">Détails de la demande
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            {% if messages %}
            {% for message in messages %}
            <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
                <strong>{{ message }}</strong>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endfor %}
            {% endif %}
            <div class="row">
                <div class="col-md-8">
                    <div class="mb-3">
                        {% if request.user|has_role:'admin' or request.user|has_role:'academic_officer'  %}
                        <a href="{% url 'dashboard:student:update_online_registrant' pk=applicant.id %}"
                           class="btn btn-primary">Modifier</a>
                        {% if not applicant.admitted %}
                        <a href="{% url 'dashboard:student:admit_student' pk=applicant.pk %}"
                           class="btn btn-success">
                            Valider <i class="fas fa-check"></i>
                        </a>
                        {% endif %}
                        {% if not applicant.admitted %}
                        <a href="{% url 'dashboard:student:reject_student' pk=applicant.pk %}"
                           class="btn btn-danger">
                            Rejeter <i class="fas fa-xmark"></i>
                        </a>
                        {% endif %}
                        {% endif %}
                    </div>
                    <div class="about-info">
                        <div class="media mt-3">
                            <img src="{{ applicant.photo.url }}" class="mr-3" alt="...">
                            <div class="media-body">
                                <ul>
                                    <li><span class="title-span">Nom : </span><span class="info-span">{{ applicant.last_name }} {{ applicant.first_name }}</span>
                                    </li>
                                    <li>
                                        <span class="title-span">Filière choisie: </span> <strong><span
                                            class="info-span badge badge-dark">{{ applicant.department_choice }}</span></strong>
                                    </li>
                                    <li><span class="title-span">Mobile: </span><span class="info-span">{{ applicant.mobile_number }}</span>
                                    </li>
                                    <li><span class="title-span">Email: </span><span class="info-span">{{ applicant.email }}</span>
                                    </li>
                                    <li><span class="title-span">Sexe : </span><span class="info-span">{{ applicant.gender }}</span>
                                    </li>

                                </ul>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <ul>
                                    <hr>
                                    <li><span class="mr-4">Date de naissance : </span><span class="info-span">{{ applicant.date_of_birth }}</span>
                                    </li>
                                    <li><span class="title-span">Nationalité : </span><span class="info-span">{{ applicant.nationality }}</span>
                                    </li>
                                    <li><span class="mr-4">Année d'obtention du BAC : </span><span
                                            class="info-span">{{ applicant.bac_passing_year }}</span>
                                    </li>
                                    <hr>
                                    <li>
                                        <span class="mr-4">Nom du père : </span> <span class="info-span">{{ applicant.fathers_last_name }} {{ applicant.fathers_first_name }}</span>
                                    </li>
                                    <li><span class="mr-4">Nom de la mère : </span><span class="info-span">{{ applicant.mothers_last_name }} {{ applicant.mothers_first_name }}</span>
                                    </li>
                                    <li><span class="mr-4">Numéro du père : </span><span class="info-span">{{ applicant.fathers_mobile_number }}</span>
                                    </li>
                                    <li><span class="mr-4">Numéro de la mère : </span><span class="info-span">{{ applicant.mothers_mobile_number }}</span>
                                    </li>
                                    <li><span class="mr-4">Numéro de la personne à prévenir : </span><span
                                            class="info-span">{{ applicant.guardian_mobile_number }}</span>
                                    </li>
                                    <hr>
                                    <li><span class="mr-3">Adresse permanente : </span><span class="info-span">{{ applicant.permanent_address }}</span>
                                    </li>
                                    <li><span class="mr-3">Adresse courante : </span><span class="info-span">{{ applicant.current_address }}</span>
                                    </li>
                                    <hr>

                                </ul>
                            </div>
                        </div>


                        <div class="row">
                            <div class="col-md-4">

                            </div>
                            <div class="col-md-4 mb-3">
                                <h5>Relevé du BAC</h5>
                                <a href="{{applicant.bac_marksheet.url}}" target="_blank" rel="noopener noreferrer">
                                    <canvas id="the-canvas" style="height:500px;">
                                    </canvas>
                                    {{applicant.bac_marksheet.url|json_script:'mydata'}}
                                </a>

                            </div>

                            <div class="col-md-4 mb-3">
                                {% if applicant.last_exam_marksheet %}
                                <a href="{{ applicant.bac_marksheet.url }}">
                                    <canvas id="the-canvas2" style="height:500px;">
                                    </canvas>
                                    {{applicant.last_exam_marksheet.url|json_script:'mydata'}}
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Update Counseling Data -->
                    <div class="card p-3 mb-5">
                        <form action="{% url 'dashboard:student:add_counseling_data' student_id=applicant.id %}"
                              method="post">
                            {{ counseling_form|crispy }}
                            {% csrf_token %}
                            <input type="submit" class="btn btn-primary" value="Sauvegarder">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                        </form>
                    </div>
                    <!-- Display Counseling Data -->
                    <ul class="list-group card">
                        <li class="list-group-item active">Informations relatives au conseil</li>
                        {% for record in counseling_records.all %}
                        <li class="list-group-item">
                            {{ record }} <br>
                            <span class="badge badge-dark mr-1">
                        <strong>Commenter par:</strong>
                        {{ record.counselor }}
                    </span>
                            <span class="badge badge-info text-light">
                        <strong>Date:</strong>
                        {{ record.created|date:"d b Y "}}
                    </span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block customjs %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.0.279/pdf.worker.min.js"
        integrity="sha512-UiXicZonl1pXJaZk0apG3TN/yE/a52JjAyZmr1MmvjI01f7MURJD+M4UUdBxxz1Zzte1zjie37VtotaR3b1/1g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
const mydata = JSON.parse(document.getElementById('mydata').textContent);
console.log(mydata);

// The workerSrc property shall be specified.
pdfjsLib.GlobalWorkerOptions.workerSrc = '//cdnjs.cloudflare.com/ajax/libs/pdf.js/3.0.279/pdf.worker.min.js';
    // Asynchronous download of PDF

var loadingTask = pdfjsLib.getDocument(mydata);
loadingTask.promise.then(function (pdf) {
    console.log('PDF loaded');

    // Fetch the first page
    var pageNumber = 1;
    pdf.getPage(pageNumber).then(function (page) {
        console.log('Page loaded');

        var scale = 1;
        var viewport = page.getViewport({ scale: scale });

        // Prepare canvas using PDF page dimensions
        var canvas = document.getElementById('the-canvas');
        var canvas2 = document.getElementById('the-canvas2');

        var context = canvas.getContext('2d');
        var context2 = canvas2.getContext('2d');

        canvas.height = viewport.height;
        canvas.width = viewport.width;

        canvas2.height = viewport.height;
        canvas2.width = viewport.width;

        // Render PDF page into canvas context
        var renderContext = {
            canvasContext: context,
            viewport: viewport
        };

        var renderContext2 = {
            canvasContext2: context2,
            viewport: viewport
        };

        var renderTask = page.render(renderContext);

        var renderTask2 = page.render(renderContext2);

        renderTask.promise.then(function () {
            console.log('Page rendered');
        });
    });
}, function (reason) {
    // PDF loading error
    console.error(reason);
});














</script>
{% endblock %}
