{% extends 'layouts/base_dash.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_header %}
{% endblock %}

{% block content %}
<div class="container-fluid content">
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <h3 class="page-title">Inscriptions non payées</h3>
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard:student:students_board' %}">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active">Liste des inscriptions non payées</li>
                </ul>
            </div>
            <div class="col-auto text-right float-right ml-auto">
                <a href="#" class="btn btn-outline-primary mr-2"><i class="fas fa-download"></i> Download</a>
                <a href="{% url 'dashboard:student:add_student' %}" class="btn btn-primary"><i
                        class="fas fa-plus"></i></a>
            </div>
        </div>
    </div>


    <!-- Online Applicants Table Row -->
    <div class="row">
        <div class="col-sm-12">
            <div class="card card-table">
                <div class="card-body">
                    <!-- Online Applicants Table -->
                    <div class="table-responsive">
                        <table class="table table-hover table-center mb-0 datatable">
                            <thead>
                            <tr>
                                <th scope="col">SYL</th>
                                <th scope="col">Image</th>
                                <th scope="col">Nom</th>
                                <th scope="col">Prénom</th>
                                <th scope="col">Contact</th>
                                <th scope="col">Département Choisi</th>
                                <th scope="col">Date de demande</th>
                                <th scope="col">Action</th>
                            </tr>
                            </thead>
                            <tbody class="bg-light">

                            {% for applicant in unpaid_applicants %}
                            <tr>
                                <th scope="row">{{ forloop.counter }}</th>
                                <td>
                                    <img src="{{ applicant.photo.url }}" width="50" height="50">
                                </td>
                                <td>
                                    <a href="{% url 'dashboard:student:update_online_registrant' pk=applicant.id %}"
                                       class="text-dark">
                                        {{ applicant.last_name|upper }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'dashboard:student:update_online_registrant' pk=applicant.id %}"
                                       class="text-dark">
                                        {{ applicant.first_name|capfirst }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'dashboard:student:update_online_registrant' pk=applicant.id %}"
                                       class="text-dark">
                                        {{ applicant.mobile_number }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'dashboard:student:update_online_registrant' pk=applicant.id %}"
                                       class="text-dark">
                                        {{ applicant.department_choice }}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'dashboard:student:update_online_registrant' pk=applicant.id %}"
                                       class="text-dark">
                                        {{ applicant.created }}
                                    </a>
                                </td>
                                <td>
                                    <form action="" method="post" class="mark-paid-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="registrant_id" value="{{ applicant.pk }}">
                                        <button type="submit" class="btn btn-sm mark-paid-btn btn-dark mb-1 btn-block">
                                            <span class="mark-paid-text">Marquer comme payer</span>
                                        </button>
                                    </form>
                                    <a href="{% url 'dashboard:student:admit_student' pk=applicant.pk %}"
                                       class="btn btn-sm btn-primary d-block">
                                        valider
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block customjs %}
<script>
        const forms = document.querySelectorAll('.mark-paid-form');
        forms.forEach(function(element){
            element.addEventListener('submit', function(event){
                event.preventDefault();
                const serializedData = $(this).serialize();
                changePayStatus(element, serializedData)
            });
        });

        function changePayStatus(element, data){
            const url = "{% url 'dashboard:student:mark_as_paid_or_unpaid' %}";
            $.ajax({
                type: 'POST',
                url: url,
                data: data,
                success: function(response) {
                    if (response.data) {
                        element.querySelector('.mark-paid-text').innerHTML = '<b>PAYER</b>'
                    } else {
                        element.querySelector('.mark-paid-text').innerHTML = '<b>Marquer comme payer</b>'
                    }
                },
                error: function(error){
                    console.log(error);
                }
            });
        }

</script>
{% endblock %}